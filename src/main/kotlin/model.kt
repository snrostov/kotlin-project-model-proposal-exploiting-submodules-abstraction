sealed class VariantQualifier
object XZ : VariantQualifier()
object JVM : VariantQualifier()
object JS : VariantQualifier()
object Native : VariantQualifier()

sealed class Scope
object Api : Scope()
object Implementation : Scope()

interface DependencyAware {
    val dependencies: MutableList<Dependency>
}

class DependencyBuilder(
    val dependencies: MutableList<Dependency>
) {
    fun api(module: Module) = dependencies.add(Dependency(Api, module.id))
}

class Module(val id: String) : DependencyAware {
    val common = ModuleFragment()

    val variants = mutableListOf<ModuleVariant>()

    override val dependencies: MutableList<Dependency> get() = common.dependencies

    operator fun VariantQualifier.invoke(body: ModuleVariant.() -> Unit) {
        variant(this, body)
    }
}

class ModuleVariant(val module: Module, val qualifier: VariantQualifier) : DependencyAware {
    val defaultFragment = ModuleFragment()

    fun includes(fragment: ModuleFragment) {
        defaultFragment.includes(fragment)
    }

    lateinit var artficat: Artifact

    override val dependencies = mutableListOf<Dependency>()
    val variantDependencies = mutableListOf<ModuleVariant>()

    fun api(moduleVariant: ModuleVariant) =
        variantDependencies.add(moduleVariant)
}

class ModuleFragment: DependencyAware {
    override val dependencies = mutableListOf<Dependency>()

    val includes = mutableListOf<ModuleFragment>()

    fun includes(fragment: ModuleFragment) {
        includes.add(fragment)
    }
}

class Dependency(
    val scope: Scope,
    val targetId: String
)

fun module(id: String, body: Module.() -> Unit) = Module(id).also(body)

fun Module.fragment(body: ModuleVariant.() -> Unit) = ModuleFragment()

fun Module.variant(qualifier: VariantQualifier? = null, body: ModuleVariant.() -> Unit) =
    ModuleVariant(this, qualifier!!).also(body)

fun DependencyAware.dependencies(body: DependencyBuilder.() -> Unit) {
    body(DependencyBuilder(dependencies))
}