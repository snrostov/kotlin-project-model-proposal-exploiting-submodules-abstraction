import kotlin.reflect.KClass

typealias Id = String

interface Identifiable {
    val id: Id
}

class Arena {
    val types = mutableMapOf<KClass<*>, ArenaOf<*>>()

    private fun <T : Identifiable> arenaOf(type: KClass<T>): ArenaOf<T> =
        types.getOrPut(type) { ArenaOf<T>() } as ArenaOf<T>

    fun <T : Identifiable> ref(obj: T): Ref<T> = arenaOf(obj::class as KClass<T>).ref(obj)
}

class ArenaOf<T : Identifiable> {
    val refs = mutableMapOf<Id, Ref<T>>()

    fun ref(obj: T): Ref<T> = refs.getOrPut(obj.id) { Ref(this, obj.id) }
    fun resolve(ref: Ref<T>): T = TODO()
}

data class Ref<out T : Identifiable> constructor(
    private val arena: ArenaOf<T>,
    val id: Id
) {
    private var resolved: T? = null

    fun resolve(): T = resolved ?: arena.resolve(this).also { resolved = it }
}
