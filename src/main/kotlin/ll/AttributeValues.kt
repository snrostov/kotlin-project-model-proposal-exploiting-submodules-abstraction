package ll

class AttributeValues(val parent: AttributeValues? = null) {
    private val values = mutableMapOf<Attribute<Any>, Set<Any>>()

    @Suppress("UNCHECKED_CAST")
    operator fun <V : Any> set(attribute: Attribute<V>, value: List<V>) {
        values[attribute as Attribute<Any>] = value.toSet()
    }

    @Suppress("UNCHECKED_CAST")
    operator fun <V : Any> get(attribute: Attribute<V>): Set<V> {
        return (values[attribute as Attribute<Any>] as Set<V>?)
            ?: parent?.get(attribute) as Set<V>?
            ?: setOf()
    }

    fun remove(attribute: Attribute<*>) {
        values.remove(attribute)
    }

    fun isCompatible(producer: AttributeValues) =
        values.all { (attr, values) ->
            values.all { consumerValue ->
                producer[attr].any { producerValue ->
                    attr.isCompatible(consumerValue, producerValue)
                }
            }
        }
}