package ll

open class LLModuleFragment(val module: LLModule) {
    var name: String? = null

    private var variant: Boolean = false
    fun asVariant() {
        variant = true
        module.variants.add(this)
    }

    private val inferredAttributes = AttributeValues()
    private val explicitAttributes = AttributeValues(inferredAttributes)

    private val refines = mutableListOf<LLModuleFragment>()
    private val refinedBy = mutableListOf<LLModuleFragment>()
    fun refines(other: LLModuleFragment) {
        check(module == other.module)
        refines.add(other)
        other.refinedBy.add(this)
    }

    private val dependencies = mutableListOf<LLModuleFragment>()
    fun dependsOn(other: LLModuleFragment) {
        dependencies.add(other)
    }

    fun dependsOn(module: LLModule) {
        module.fragments
            .filter { explicitAttributes.isCompatible(it.explicitAttributes) }
            .forEach {
                dependsOn(it)
            }

        refinedBy.forEach {
            it.dependsOn(module)
        }
    }

    init {
        module.fragments.add(this)
    }
}