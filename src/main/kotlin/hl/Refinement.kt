package hl

import ll.LLModuleFragment

class Refinement(val module: Module, val parent: Refinement?) {
    private val fragment = LLModuleFragment(module.module)
    private val children = mutableListOf<Refinement>()

    fun refinement(body: Refinement.() -> Unit) =
        Refinement(module, this).also {
            children.add(it)
            it.fragment.refines(fragment)
            body(it)
        }

    fun variant(body: Refinement.() -> Unit) =
        refinement {
            fragment.asVariant()
            body(this)
        }

    fun refines(other: Refinement) {
        refinesRecursively(this, other)
    }

    private fun refinesRecursively(src: Refinement, other: Refinement) {
        src.fragment.refines(other.fragment)
        other.children.forEach {
            refinesRecursively(src, it)
        }
    }

    fun dependsOn(module: Module) {
        fragment.dependsOn(module.module)
    }
}