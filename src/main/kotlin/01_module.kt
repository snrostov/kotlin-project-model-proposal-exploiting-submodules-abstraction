fun module(id: String, body: Module.() -> Unit) = Module(id).also(body)

sealed class ModuleVariantsContainer : ModuleFragmentConfiguration {
    abstract val module: Module

    val common = ModuleFragment(module)

    override val delegatedModuleFragment: ModuleFragment
        get() = common

    val variants = mutableListOf<ModuleVariantsContainer>()

    inline fun targets(body: ModuleVariantsGroup.() -> Unit) =
        ModuleVariantsGroup("", this).also(body)
}

class Module(val id: String) : ModuleVariantsContainer() {
    override val module: Module
        get() = this

    val allVariants = mutableListOf<ModuleVariant>()

    fun fragment(body: ModuleFragment.() -> Unit) = ModuleFragment(this).also(body)

    operator fun SupplementaryKind.invoke(body: ModuleFragmentConfiguration.() -> Unit) {
        supplementary(name, body)
    }
}

class ModuleVariantsGroup(val name: String, val parent: ModuleVariantsContainer) : ModuleVariantsContainer() {
    override val module: Module = parent.module

    inline fun variant(body: ModuleVariant.() -> Unit) =
        ModuleVariant(this).also(body)

    inline operator fun Platform.invoke(body: ModuleVariant.() -> Unit): ModuleVariant = variant {
        attributes {
            platform = this@invoke
        }

        body()
    }

    inline fun variants(name: String, body: ModuleVariantsGroup.() -> Unit) =
        ModuleVariantsGroup(name, this).also(body)

    inline operator fun PlatformKind<*>.invoke(body: ModuleVariantsGroup.() -> Unit) = variants("") {
        body()
    }
}

class ModuleVariant(val parent: ModuleVariantsContainer) : ModuleVariantsContainer() {
    override val module: Module
        get() = parent.module

    init {
        module.allVariants.add(this)
    }

    lateinit var artficat: Artifact

    val attributes = VariantAttributeValues()

    fun attributes(body: VariantAttributeValues.() -> Unit) {
        attributes.body()
    }

    inline operator fun SupplementaryKind.invoke(body: ModuleVariant.() -> Unit) =
        ModuleVariant(this@ModuleVariant).also {
            attributes {
                supplementaryKind = this@invoke
            }

            body()
        }
}