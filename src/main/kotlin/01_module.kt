fun module(id: String, body: Module.() -> Unit) = Module(null, id).also(body)

@DslMarker
annotation class ProjectDsl

abstract class AbstractModule : ModuleDsl {
    override val moduleDslDelegate: AbstractModule
        get() = this

    val privateChildren = mutableListOf<Module>()
    val dependencies = mutableListOf<Dependency>()
}

@ProjectDsl
interface ModuleDsl {
    val moduleDslDelegate: AbstractModule

    fun dependencies(body: DependencyBuilder.() -> Unit) {
        body(DependencyBuilder(moduleDslDelegate.dependencies))
    }

    fun privateModule(name: String, body: PrivateModule.() -> Unit) =
        PrivateModule(moduleDslDelegate, name).also {
            it.apply(body)
        }

    fun test(body: PrivateModule.() -> Unit) = privateModule("test", body)
}

@ProjectDsl
class Module(val parent: Module?, val id: String) : AbstractModule() {
    val publicChildren = mutableListOf<Module>()
    val variants = mutableListOf<ModuleVariant>()

    fun targets(body: TargetsDsl.() -> Unit) {

    }

    inner class TargetsDsl {
        operator fun Platform.invoke(body: ModuleVariant.() -> Unit) {
        }
    }
}

@ProjectDsl
interface PrivateModuleDsl : ModuleDsl {
    override val moduleDslDelegate: PrivateModule

    fun extends(other: AbstractModule) {
        moduleDslDelegate.parents.add(other)
    }
}

@ProjectDsl
class PrivateModule(parent: AbstractModule, val id: String) : AbstractModule(), PrivateModuleDsl {
    override val moduleDslDelegate: PrivateModule
        get() = this

    val parents = mutableListOf<AbstractModule>(parent)
}

@ProjectDsl
class ModuleVariant(val module: Module, val parentVariant: ModuleVariant?, name: String) : PrivateModuleDsl {
    val entry = PrivateModule(module, name)

    override val moduleDslDelegate: PrivateModule
        get() = entry
}